import "core-js/modules/es.array.iterator";
import "core-js/modules/es.promise";
import _Promise from "@babel/runtime-corejs3/core-js-stable/promise";
import _JSON$stringify from "@babel/runtime-corejs3/core-js-stable/json/stringify";
import os from 'os';
import fs from 'fs-extra';
import path from 'path';
import { Cli } from '../cli/cli';
import { VERSION } from '..';
import { Command } from 'commander';
function getCacheFileDir() {
  return path.join(os.tmpdir(), 'jsforce-gen-schema-cache');
}
function getCacheFilePath(orgId) {
  return path.join(getCacheFileDir(), orgId, 'describe.json');
}
async function readDescribedCache(orgId) {
  try {
    const cacheFile = getCacheFilePath(orgId);
    const data = await fs.readFile(cacheFile, 'utf8');
    return JSON.parse(data);
  } catch (e) {
    return null;
  }
}
async function loadDescribeResult(conn, orgId, cache) {
  console.info('describing global');
  const {
    sobjects: sos
  } = await conn.describeGlobal();
  const sobjects = [];
  for (const {
    name
  } of sos) {
    console.info('describing ' + name);
    const so = await conn.describe(name);
    sobjects.push(so);
  }
  if (cache) {
    const cacheFile = getCacheFilePath(orgId);
    await fs.outputFile(cacheFile, _JSON$stringify(sobjects, null, 2), 'utf8');
  }
  return sobjects;
}
function getParentReferences(sobject) {
  const parentReferences = [];
  for (const {
    type,
    nillable,
    relationshipName,
    referenceTo
  } of sobject.fields) {
    if (type === 'reference' && relationshipName && referenceTo && referenceTo.length > 0) {
      const parentSObject = referenceTo.length > 1 ? 'Name' : referenceTo[0];
      parentReferences.push({
        nillable,
        parentSObject,
        relationshipName
      });
    }
  }
  return parentReferences;
}
function getTSTypeString(type) {
  return type === 'double' || type === 'int' || type === 'currency' || type === 'percent' ? 'number' : type === 'boolean' ? 'boolean' : type === 'date' || type === 'datetime' || type === 'time' ? 'DateString' : type === 'base64' ? 'BlobString' : type === 'address' ? 'Address' : type === 'complexvalue' ? 'any' : 'string';
}
async function dumpSchema(conn, orgId, outputFile, schemaName, cache) {
  const sobjects = (cache ? await readDescribedCache(orgId) : null) || (await loadDescribeResult(conn, orgId, cache));
  await fs.ensureFile(outputFile);
  const out = fs.createWriteStream(outputFile, 'utf8');
  return new _Promise((resolve, reject) => {
    out.on('error', err => reject(err));
    out.on('finish', resolve);
    const writeLine = message => out.write(message + '\n');
    writeLine("import { Schema, SObjectDefinition, DateString, BlobString, Address } from 'jsforce';");
    writeLine('');
    for (const sobject of sobjects) {
      const {
        name,
        fields,
        childRelationships
      } = sobject;
      writeLine(`type Fields$${name} = {`);
      writeLine('  //');
      for (const {
        name,
        type,
        nillable
      } of fields) {
        const tsType = getTSTypeString(type);
        const orNull = nillable ? ' | null' : '';
        writeLine(`  ${name}: ${tsType}${orNull};`);
      }
      writeLine('};');
      writeLine('');
      writeLine(`type ParentReferences$${name} = {`);
      writeLine('  //');
      const parentReferences = getParentReferences(sobject);
      for (const {
        nillable,
        parentSObject,
        relationshipName
      } of parentReferences) {
        const orNull = nillable ? ' | null' : '';
        writeLine(`  ${relationshipName}: SObjectDefinition$${parentSObject}${orNull};`);
      }
      writeLine('};');
      writeLine('');
      writeLine(`type ChildRelationships$${name} = {`);
      writeLine('  //');
      for (const {
        field,
        childSObject,
        relationshipName
      } of childRelationships) {
        if (field && childSObject && relationshipName && !/__c$/.test(field)) {
          writeLine(`  ${relationshipName}: SObjectDefinition$${childSObject};`);
        }
      }
      writeLine('};');
      writeLine('');
      writeLine(`interface SObjectDefinition$${name} extends SObjectDefinition<'${name}'> {
    Name: '${name}';
    Fields: Fields$${name};
    ParentReferences: ParentReferences$${name};
    ChildRelationships: ChildRelationships$${name};
  }`);
      writeLine('');
    }
    writeLine('');
    writeLine(`export interface ${schemaName} extends Schema {`);
    writeLine('  SObjects: {');
    for (const {
      name
    } of sobjects) {
      writeLine(`    ${name}: SObjectDefinition$${name};`);
    }
    writeLine('  };');
    writeLine('}');
    out.end();
  });
}
/**
 *
 */
function readCommand() {
  return new Command().option('-u, --username [username]', 'Salesforce username').option('-p, --password [password]', 'Salesforce password (and security token, if available)').option('-c, --connection [connection]', 'Connection name stored in connection registry').option('-l, --loginUrl [loginUrl]', 'Salesforce login url').option('-n, --schemaName [schemaName]', 'Name of schema type', 'MySchema').requiredOption('-o, --outputFile <outputFile>', 'Generated schema file path', './schema.d.ts').option('--sandbox', 'Login to Salesforce sandbox').option('--no-cache', 'Do not generate cache file for described result in tmp directory').option('--clearCache', 'Clear all existing described cache files').version(VERSION).parse(process.argv);
}

/**
 *
 */
export default async function main() {
  const program = readCommand();
  const cli = new Cli();
  await cli.connect(program);
  const conn = cli.getCurrentConnection();
  if (!conn.userInfo) {
    console.error('Cannot connect to Salesforce');
    return;
  }
  await dumpSchema(conn, conn.userInfo.organizationId, program.outputFile, program.schemaName, program.cache);
  if (program.clearCache) {
    console.log('removing cache files');
    await fs.remove(getCacheFileDir());
  }
  console.log(`Dumped to: ${program.outputFile}`);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJvcyIsImZzIiwicGF0aCIsIkNsaSIsIlZFUlNJT04iLCJDb21tYW5kIiwiZ2V0Q2FjaGVGaWxlRGlyIiwiam9pbiIsInRtcGRpciIsImdldENhY2hlRmlsZVBhdGgiLCJvcmdJZCIsInJlYWREZXNjcmliZWRDYWNoZSIsImNhY2hlRmlsZSIsImRhdGEiLCJyZWFkRmlsZSIsIkpTT04iLCJwYXJzZSIsImUiLCJsb2FkRGVzY3JpYmVSZXN1bHQiLCJjb25uIiwiY2FjaGUiLCJjb25zb2xlIiwiaW5mbyIsInNvYmplY3RzIiwic29zIiwiZGVzY3JpYmVHbG9iYWwiLCJuYW1lIiwic28iLCJkZXNjcmliZSIsInB1c2giLCJvdXRwdXRGaWxlIiwiX0pTT04kc3RyaW5naWZ5IiwiZ2V0UGFyZW50UmVmZXJlbmNlcyIsInNvYmplY3QiLCJwYXJlbnRSZWZlcmVuY2VzIiwidHlwZSIsIm5pbGxhYmxlIiwicmVsYXRpb25zaGlwTmFtZSIsInJlZmVyZW5jZVRvIiwiZmllbGRzIiwibGVuZ3RoIiwicGFyZW50U09iamVjdCIsImdldFRTVHlwZVN0cmluZyIsImR1bXBTY2hlbWEiLCJzY2hlbWFOYW1lIiwiZW5zdXJlRmlsZSIsIm91dCIsImNyZWF0ZVdyaXRlU3RyZWFtIiwiX1Byb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwib24iLCJlcnIiLCJ3cml0ZUxpbmUiLCJtZXNzYWdlIiwid3JpdGUiLCJjaGlsZFJlbGF0aW9uc2hpcHMiLCJ0c1R5cGUiLCJvck51bGwiLCJmaWVsZCIsImNoaWxkU09iamVjdCIsInRlc3QiLCJlbmQiLCJyZWFkQ29tbWFuZCIsIm9wdGlvbiIsInJlcXVpcmVkT3B0aW9uIiwidmVyc2lvbiIsInByb2Nlc3MiLCJhcmd2IiwibWFpbiIsInByb2dyYW0iLCJjbGkiLCJjb25uZWN0IiwiZ2V0Q3VycmVudENvbm5lY3Rpb24iLCJ1c2VySW5mbyIsImVycm9yIiwib3JnYW5pemF0aW9uSWQiLCJjbGVhckNhY2hlIiwibG9nIiwicmVtb3ZlIl0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL3NjaGVtYS9nZW5lcmF0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBmcyBmcm9tICdmcy1leHRyYSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IERlc2NyaWJlU09iamVjdFJlc3VsdCB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IENsaSB9IGZyb20gJy4uL2NsaS9jbGknO1xuaW1wb3J0IHsgQ29ubmVjdGlvbiwgVkVSU0lPTiB9IGZyb20gJy4uJztcbmltcG9ydCB7IENvbW1hbmQgfSBmcm9tICdjb21tYW5kZXInO1xuXG50eXBlIFVud3JhcFByb21pc2U8VD4gPSBUIGV4dGVuZHMgUHJvbWlzZTxpbmZlciBVPiA/IFUgOiBuZXZlcjtcblxuZnVuY3Rpb24gZ2V0Q2FjaGVGaWxlRGlyKCkge1xuICByZXR1cm4gcGF0aC5qb2luKG9zLnRtcGRpcigpLCAnanNmb3JjZS1nZW4tc2NoZW1hLWNhY2hlJyk7XG59XG5cbmZ1bmN0aW9uIGdldENhY2hlRmlsZVBhdGgob3JnSWQ6IHN0cmluZykge1xuICByZXR1cm4gcGF0aC5qb2luKGdldENhY2hlRmlsZURpcigpLCBvcmdJZCwgJ2Rlc2NyaWJlLmpzb24nKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVhZERlc2NyaWJlZENhY2hlKFxuICBvcmdJZDogc3RyaW5nLFxuKTogUHJvbWlzZTxVbndyYXBQcm9taXNlPFJldHVyblR5cGU8dHlwZW9mIGxvYWREZXNjcmliZVJlc3VsdD4+IHwgbnVsbD4ge1xuICB0cnkge1xuICAgIGNvbnN0IGNhY2hlRmlsZSA9IGdldENhY2hlRmlsZVBhdGgob3JnSWQpO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBmcy5yZWFkRmlsZShjYWNoZUZpbGUsICd1dGY4Jyk7XG4gICAgcmV0dXJuIEpTT04ucGFyc2UoZGF0YSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBsb2FkRGVzY3JpYmVSZXN1bHQoXG4gIGNvbm46IENvbm5lY3Rpb24sXG4gIG9yZ0lkOiBzdHJpbmcsXG4gIGNhY2hlPzogYm9vbGVhbixcbikge1xuICBjb25zb2xlLmluZm8oJ2Rlc2NyaWJpbmcgZ2xvYmFsJyk7XG4gIGNvbnN0IHsgc29iamVjdHM6IHNvcyB9ID0gYXdhaXQgY29ubi5kZXNjcmliZUdsb2JhbCgpO1xuICBjb25zdCBzb2JqZWN0cyA9IFtdO1xuICBmb3IgKGNvbnN0IHsgbmFtZSB9IG9mIHNvcykge1xuICAgIGNvbnNvbGUuaW5mbygnZGVzY3JpYmluZyAnICsgbmFtZSk7XG4gICAgY29uc3Qgc28gPSBhd2FpdCBjb25uLmRlc2NyaWJlKG5hbWUpO1xuICAgIHNvYmplY3RzLnB1c2goc28pO1xuICB9XG4gIGlmIChjYWNoZSkge1xuICAgIGNvbnN0IGNhY2hlRmlsZSA9IGdldENhY2hlRmlsZVBhdGgob3JnSWQpO1xuICAgIGF3YWl0IGZzLm91dHB1dEZpbGUoY2FjaGVGaWxlLCBKU09OLnN0cmluZ2lmeShzb2JqZWN0cywgbnVsbCwgMiksICd1dGY4Jyk7XG4gIH1cbiAgcmV0dXJuIHNvYmplY3RzO1xufVxuXG5mdW5jdGlvbiBnZXRQYXJlbnRSZWZlcmVuY2VzKHNvYmplY3Q6IERlc2NyaWJlU09iamVjdFJlc3VsdCkge1xuICBjb25zdCBwYXJlbnRSZWZlcmVuY2VzID0gW107XG4gIGZvciAoY29uc3Qge1xuICAgIHR5cGUsXG4gICAgbmlsbGFibGUsXG4gICAgcmVsYXRpb25zaGlwTmFtZSxcbiAgICByZWZlcmVuY2VUbyxcbiAgfSBvZiBzb2JqZWN0LmZpZWxkcykge1xuICAgIGlmIChcbiAgICAgIHR5cGUgPT09ICdyZWZlcmVuY2UnICYmXG4gICAgICByZWxhdGlvbnNoaXBOYW1lICYmXG4gICAgICByZWZlcmVuY2VUbyAmJlxuICAgICAgcmVmZXJlbmNlVG8ubGVuZ3RoID4gMFxuICAgICkge1xuICAgICAgY29uc3QgcGFyZW50U09iamVjdCA9IHJlZmVyZW5jZVRvLmxlbmd0aCA+IDEgPyAnTmFtZScgOiByZWZlcmVuY2VUb1swXTtcbiAgICAgIHBhcmVudFJlZmVyZW5jZXMucHVzaCh7IG5pbGxhYmxlLCBwYXJlbnRTT2JqZWN0LCByZWxhdGlvbnNoaXBOYW1lIH0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcGFyZW50UmVmZXJlbmNlcztcbn1cblxuZnVuY3Rpb24gZ2V0VFNUeXBlU3RyaW5nKHR5cGU6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiB0eXBlID09PSAnZG91YmxlJyB8fFxuICAgIHR5cGUgPT09ICdpbnQnIHx8XG4gICAgdHlwZSA9PT0gJ2N1cnJlbmN5JyB8fFxuICAgIHR5cGUgPT09ICdwZXJjZW50J1xuICAgID8gJ251bWJlcidcbiAgICA6IHR5cGUgPT09ICdib29sZWFuJ1xuICAgID8gJ2Jvb2xlYW4nXG4gICAgOiB0eXBlID09PSAnZGF0ZScgfHwgdHlwZSA9PT0gJ2RhdGV0aW1lJyB8fCB0eXBlID09PSAndGltZSdcbiAgICA/ICdEYXRlU3RyaW5nJ1xuICAgIDogdHlwZSA9PT0gJ2Jhc2U2NCdcbiAgICA/ICdCbG9iU3RyaW5nJ1xuICAgIDogdHlwZSA9PT0gJ2FkZHJlc3MnXG4gICAgPyAnQWRkcmVzcydcbiAgICA6IHR5cGUgPT09ICdjb21wbGV4dmFsdWUnXG4gICAgPyAnYW55J1xuICAgIDogJ3N0cmluZyc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGR1bXBTY2hlbWEoXG4gIGNvbm46IENvbm5lY3Rpb24sXG4gIG9yZ0lkOiBzdHJpbmcsXG4gIG91dHB1dEZpbGU6IHN0cmluZyxcbiAgc2NoZW1hTmFtZTogc3RyaW5nLFxuICBjYWNoZT86IGJvb2xlYW4sXG4pIHtcbiAgY29uc3Qgc29iamVjdHMgPVxuICAgIChjYWNoZSA/IGF3YWl0IHJlYWREZXNjcmliZWRDYWNoZShvcmdJZCkgOiBudWxsKSB8fFxuICAgIChhd2FpdCBsb2FkRGVzY3JpYmVSZXN1bHQoY29ubiwgb3JnSWQsIGNhY2hlKSk7XG4gIGF3YWl0IGZzLmVuc3VyZUZpbGUob3V0cHV0RmlsZSk7XG4gIGNvbnN0IG91dCA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKG91dHB1dEZpbGUsICd1dGY4Jyk7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgb3V0Lm9uKCdlcnJvcicsIChlcnIpID0+IHJlamVjdChlcnIpKTtcbiAgICBvdXQub24oJ2ZpbmlzaCcsIHJlc29sdmUpO1xuICAgIGNvbnN0IHdyaXRlTGluZSA9IChtZXNzYWdlOiBzdHJpbmcpID0+IG91dC53cml0ZShtZXNzYWdlICsgJ1xcbicpO1xuICAgIHdyaXRlTGluZShcbiAgICAgIFwiaW1wb3J0IHsgU2NoZW1hLCBTT2JqZWN0RGVmaW5pdGlvbiwgRGF0ZVN0cmluZywgQmxvYlN0cmluZywgQWRkcmVzcyB9IGZyb20gJ2pzZm9yY2UnO1wiLFxuICAgICk7XG4gICAgd3JpdGVMaW5lKCcnKTtcbiAgICBmb3IgKGNvbnN0IHNvYmplY3Qgb2Ygc29iamVjdHMpIHtcbiAgICAgIGNvbnN0IHsgbmFtZSwgZmllbGRzLCBjaGlsZFJlbGF0aW9uc2hpcHMgfSA9IHNvYmplY3Q7XG4gICAgICB3cml0ZUxpbmUoYHR5cGUgRmllbGRzJCR7bmFtZX0gPSB7YCk7XG4gICAgICB3cml0ZUxpbmUoJyAgLy8nKTtcbiAgICAgIGZvciAoY29uc3QgeyBuYW1lLCB0eXBlLCBuaWxsYWJsZSB9IG9mIGZpZWxkcykge1xuICAgICAgICBjb25zdCB0c1R5cGUgPSBnZXRUU1R5cGVTdHJpbmcodHlwZSk7XG4gICAgICAgIGNvbnN0IG9yTnVsbCA9IG5pbGxhYmxlID8gJyB8IG51bGwnIDogJyc7XG4gICAgICAgIHdyaXRlTGluZShgICAke25hbWV9OiAke3RzVHlwZX0ke29yTnVsbH07YCk7XG4gICAgICB9XG4gICAgICB3cml0ZUxpbmUoJ307Jyk7XG4gICAgICB3cml0ZUxpbmUoJycpO1xuICAgICAgd3JpdGVMaW5lKGB0eXBlIFBhcmVudFJlZmVyZW5jZXMkJHtuYW1lfSA9IHtgKTtcbiAgICAgIHdyaXRlTGluZSgnICAvLycpO1xuICAgICAgY29uc3QgcGFyZW50UmVmZXJlbmNlcyA9IGdldFBhcmVudFJlZmVyZW5jZXMoc29iamVjdCk7XG4gICAgICBmb3IgKGNvbnN0IHtcbiAgICAgICAgbmlsbGFibGUsXG4gICAgICAgIHBhcmVudFNPYmplY3QsXG4gICAgICAgIHJlbGF0aW9uc2hpcE5hbWUsXG4gICAgICB9IG9mIHBhcmVudFJlZmVyZW5jZXMpIHtcbiAgICAgICAgY29uc3Qgb3JOdWxsID0gbmlsbGFibGUgPyAnIHwgbnVsbCcgOiAnJztcbiAgICAgICAgd3JpdGVMaW5lKFxuICAgICAgICAgIGAgICR7cmVsYXRpb25zaGlwTmFtZX06IFNPYmplY3REZWZpbml0aW9uJCR7cGFyZW50U09iamVjdH0ke29yTnVsbH07YCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHdyaXRlTGluZSgnfTsnKTtcbiAgICAgIHdyaXRlTGluZSgnJyk7XG4gICAgICB3cml0ZUxpbmUoYHR5cGUgQ2hpbGRSZWxhdGlvbnNoaXBzJCR7bmFtZX0gPSB7YCk7XG4gICAgICB3cml0ZUxpbmUoJyAgLy8nKTtcbiAgICAgIGZvciAoY29uc3Qge1xuICAgICAgICBmaWVsZCxcbiAgICAgICAgY2hpbGRTT2JqZWN0LFxuICAgICAgICByZWxhdGlvbnNoaXBOYW1lLFxuICAgICAgfSBvZiBjaGlsZFJlbGF0aW9uc2hpcHMpIHtcbiAgICAgICAgaWYgKGZpZWxkICYmIGNoaWxkU09iamVjdCAmJiByZWxhdGlvbnNoaXBOYW1lICYmICEvX19jJC8udGVzdChmaWVsZCkpIHtcbiAgICAgICAgICB3cml0ZUxpbmUoXG4gICAgICAgICAgICBgICAke3JlbGF0aW9uc2hpcE5hbWV9OiBTT2JqZWN0RGVmaW5pdGlvbiQke2NoaWxkU09iamVjdH07YCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB3cml0ZUxpbmUoJ307Jyk7XG4gICAgICB3cml0ZUxpbmUoJycpO1xuICAgICAgd3JpdGVMaW5lKFxuICAgICAgICBgaW50ZXJmYWNlIFNPYmplY3REZWZpbml0aW9uJCR7bmFtZX0gZXh0ZW5kcyBTT2JqZWN0RGVmaW5pdGlvbjwnJHtuYW1lfSc+IHtcbiAgICBOYW1lOiAnJHtuYW1lfSc7XG4gICAgRmllbGRzOiBGaWVsZHMkJHtuYW1lfTtcbiAgICBQYXJlbnRSZWZlcmVuY2VzOiBQYXJlbnRSZWZlcmVuY2VzJCR7bmFtZX07XG4gICAgQ2hpbGRSZWxhdGlvbnNoaXBzOiBDaGlsZFJlbGF0aW9uc2hpcHMkJHtuYW1lfTtcbiAgfWAsXG4gICAgICApO1xuICAgICAgd3JpdGVMaW5lKCcnKTtcbiAgICB9XG4gICAgd3JpdGVMaW5lKCcnKTtcbiAgICB3cml0ZUxpbmUoYGV4cG9ydCBpbnRlcmZhY2UgJHtzY2hlbWFOYW1lfSBleHRlbmRzIFNjaGVtYSB7YCk7XG4gICAgd3JpdGVMaW5lKCcgIFNPYmplY3RzOiB7Jyk7XG4gICAgZm9yIChjb25zdCB7IG5hbWUgfSBvZiBzb2JqZWN0cykge1xuICAgICAgd3JpdGVMaW5lKGAgICAgJHtuYW1lfTogU09iamVjdERlZmluaXRpb24kJHtuYW1lfTtgKTtcbiAgICB9XG4gICAgd3JpdGVMaW5lKCcgIH07Jyk7XG4gICAgd3JpdGVMaW5lKCd9Jyk7XG4gICAgb3V0LmVuZCgpO1xuICB9KTtcbn1cblxuaW50ZXJmYWNlIEdlbmVyYXRvckNvbW1hbmQgZXh0ZW5kcyBDb21tYW5kIHtcbiAgY29ubmVjdGlvbj86IHN0cmluZztcbiAgdXNlcm5hbWU/OiBzdHJpbmc7XG4gIHBhc3N3b3JkPzogc3RyaW5nO1xuICBsb2dpblVybD86IHN0cmluZztcbiAgc2FuZGJveD86IGJvb2xlYW47XG4gIG91dHB1dEZpbGU6IHN0cmluZztcbiAgY2FjaGU/OiBib29sZWFuO1xuICBjbGVhckNhY2hlPzogYm9vbGVhbjtcbn1cblxuLyoqXG4gKlxuICovXG5mdW5jdGlvbiByZWFkQ29tbWFuZCgpOiBHZW5lcmF0b3JDb21tYW5kIHtcbiAgcmV0dXJuIG5ldyBDb21tYW5kKClcbiAgICAub3B0aW9uKCctdSwgLS11c2VybmFtZSBbdXNlcm5hbWVdJywgJ1NhbGVzZm9yY2UgdXNlcm5hbWUnKVxuICAgIC5vcHRpb24oXG4gICAgICAnLXAsIC0tcGFzc3dvcmQgW3Bhc3N3b3JkXScsXG4gICAgICAnU2FsZXNmb3JjZSBwYXNzd29yZCAoYW5kIHNlY3VyaXR5IHRva2VuLCBpZiBhdmFpbGFibGUpJyxcbiAgICApXG4gICAgLm9wdGlvbihcbiAgICAgICctYywgLS1jb25uZWN0aW9uIFtjb25uZWN0aW9uXScsXG4gICAgICAnQ29ubmVjdGlvbiBuYW1lIHN0b3JlZCBpbiBjb25uZWN0aW9uIHJlZ2lzdHJ5JyxcbiAgICApXG4gICAgLm9wdGlvbignLWwsIC0tbG9naW5VcmwgW2xvZ2luVXJsXScsICdTYWxlc2ZvcmNlIGxvZ2luIHVybCcpXG4gICAgLm9wdGlvbignLW4sIC0tc2NoZW1hTmFtZSBbc2NoZW1hTmFtZV0nLCAnTmFtZSBvZiBzY2hlbWEgdHlwZScsICdNeVNjaGVtYScpXG4gICAgLnJlcXVpcmVkT3B0aW9uKFxuICAgICAgJy1vLCAtLW91dHB1dEZpbGUgPG91dHB1dEZpbGU+JyxcbiAgICAgICdHZW5lcmF0ZWQgc2NoZW1hIGZpbGUgcGF0aCcsXG4gICAgICAnLi9zY2hlbWEuZC50cycsXG4gICAgKVxuICAgIC5vcHRpb24oJy0tc2FuZGJveCcsICdMb2dpbiB0byBTYWxlc2ZvcmNlIHNhbmRib3gnKVxuICAgIC5vcHRpb24oXG4gICAgICAnLS1uby1jYWNoZScsXG4gICAgICAnRG8gbm90IGdlbmVyYXRlIGNhY2hlIGZpbGUgZm9yIGRlc2NyaWJlZCByZXN1bHQgaW4gdG1wIGRpcmVjdG9yeScsXG4gICAgKVxuICAgIC5vcHRpb24oJy0tY2xlYXJDYWNoZScsICdDbGVhciBhbGwgZXhpc3RpbmcgZGVzY3JpYmVkIGNhY2hlIGZpbGVzJylcbiAgICAudmVyc2lvbihWRVJTSU9OKVxuICAgIC5wYXJzZShwcm9jZXNzLmFyZ3YpIGFzIEdlbmVyYXRvckNvbW1hbmQ7XG59XG5cbi8qKlxuICpcbiAqL1xuZXhwb3J0IGRlZmF1bHQgYXN5bmMgZnVuY3Rpb24gbWFpbigpIHtcbiAgY29uc3QgcHJvZ3JhbSA9IHJlYWRDb21tYW5kKCk7XG4gIGNvbnN0IGNsaSA9IG5ldyBDbGkoKTtcbiAgYXdhaXQgY2xpLmNvbm5lY3QocHJvZ3JhbSk7XG4gIGNvbnN0IGNvbm4gPSBjbGkuZ2V0Q3VycmVudENvbm5lY3Rpb24oKTtcbiAgaWYgKCFjb25uLnVzZXJJbmZvKSB7XG4gICAgY29uc29sZS5lcnJvcignQ2Fubm90IGNvbm5lY3QgdG8gU2FsZXNmb3JjZScpO1xuICAgIHJldHVybjtcbiAgfVxuICBhd2FpdCBkdW1wU2NoZW1hKFxuICAgIGNvbm4sXG4gICAgY29ubi51c2VySW5mby5vcmdhbml6YXRpb25JZCxcbiAgICBwcm9ncmFtLm91dHB1dEZpbGUsXG4gICAgcHJvZ3JhbS5zY2hlbWFOYW1lLFxuICAgIHByb2dyYW0uY2FjaGUsXG4gICk7XG4gIGlmIChwcm9ncmFtLmNsZWFyQ2FjaGUpIHtcbiAgICBjb25zb2xlLmxvZygncmVtb3ZpbmcgY2FjaGUgZmlsZXMnKTtcbiAgICBhd2FpdCBmcy5yZW1vdmUoZ2V0Q2FjaGVGaWxlRGlyKCkpO1xuICB9XG4gIGNvbnNvbGUubG9nKGBEdW1wZWQgdG86ICR7cHJvZ3JhbS5vdXRwdXRGaWxlfWApO1xufVxuIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBT0EsRUFBRSxNQUFNLElBQUk7QUFDbkIsT0FBT0MsRUFBRSxNQUFNLFVBQVU7QUFDekIsT0FBT0MsSUFBSSxNQUFNLE1BQU07QUFFdkIsU0FBU0MsR0FBRyxRQUFRLFlBQVk7QUFDaEMsU0FBcUJDLE9BQU8sUUFBUSxJQUFJO0FBQ3hDLFNBQVNDLE9BQU8sUUFBUSxXQUFXO0FBSW5DLFNBQVNDLGVBQWVBLENBQUEsRUFBRztFQUN6QixPQUFPSixJQUFJLENBQUNLLElBQUksQ0FBQ1AsRUFBRSxDQUFDUSxNQUFNLENBQUMsQ0FBQyxFQUFFLDBCQUEw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