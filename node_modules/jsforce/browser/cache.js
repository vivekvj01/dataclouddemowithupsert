import _Reflect$construct from "@babel/runtime-corejs3/core-js-stable/reflect/construct";
import "core-js/modules/es.array.join";
import _Promise from "@babel/runtime-corejs3/core-js-stable/promise";
import _regeneratorRuntime from "@babel/runtime-corejs3/regenerator";
import "regenerator-runtime/runtime";
import _asyncToGenerator from "@babel/runtime-corejs3/helpers/asyncToGenerator";
import _indexOfInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/index-of";
import _Object$keys2 from "@babel/runtime-corejs3/core-js-stable/object/keys";
import _JSON$stringify from "@babel/runtime-corejs3/core-js-stable/json/stringify";
import _toConsumableArray from "@babel/runtime-corejs3/helpers/toConsumableArray";
import _mapInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/map";
import _concatInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/concat";
import _classCallCheck from "@babel/runtime-corejs3/helpers/classCallCheck";
import _createClass from "@babel/runtime-corejs3/helpers/createClass";
import _assertThisInitialized from "@babel/runtime-corejs3/helpers/assertThisInitialized";
import _inherits from "@babel/runtime-corejs3/helpers/inherits";
import _possibleConstructorReturn from "@babel/runtime-corejs3/helpers/possibleConstructorReturn";
import _getPrototypeOf from "@babel/runtime-corejs3/helpers/getPrototypeOf";
import _defineProperty from "@babel/runtime-corejs3/helpers/defineProperty";
function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = _Reflect$construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }
function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !_Reflect$construct) return false; if (_Reflect$construct.sham) return false; if (typeof Proxy === "function") return true; try { Date.prototype.toString.call(_Reflect$construct(Date, [], function () {})); return true; } catch (e) { return false; } }
/**
 * @file Manages asynchronous method response cache
 * @author Shinichi Tomita <shinichi.tomita@gmail.com>
 */
import { EventEmitter } from 'events';

/**
 * type def
 */
/**
 * Class for managing cache entry
 *
 * @private
 * @class
 * @constructor
 * @template T
 */
var CacheEntry = /*#__PURE__*/function (_EventEmitter) {
  _inherits(CacheEntry, _EventEmitter);
  var _super = _createSuper(CacheEntry);
  function CacheEntry() {
    var _context;
    var _this;
    _classCallCheck(this, CacheEntry);
    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }
    _this = _super.call.apply(_super, _concatInstanceProperty(_context = [this]).call(_context, args));
    _defineProperty(_assertThisInitialized(_this), "_fetching", false);
    _defineProperty(_assertThisInitialized(_this), "_value", undefined);
    return _this;
  }
  _createClass(CacheEntry, [{
    key: "get",
    /**
     * Get value in the cache entry
     *
     * @param {() => Promise<T>} [callback] - Callback function callbacked the cache entry updated
     * @returns {T|undefined}
     */
    value: function get(callback) {
      if (callback) {
        var cb = callback;
        this.once('value', function (v) {
          return cb(v);
        });
        if (typeof this._value !== 'undefined') {
          this.emit('value', this._value);
        }
      }
      return this._value;
    }
    /**
     * Set value in the cache entry
     */
  }, {
    key: "set",
    value: function set(value) {
      this._value = value;
      this.emit('value', this._value);
    }
    /**
     * Clear cached value
     */
  }, {
    key: "clear",
    value: function clear() {
      this._fetching = false;
      this._value = undefined;
    }
  }]);
  return CacheEntry;
}(EventEmitter);
/**
 * create and return cache key from namespace and serialized arguments.
 * @private
 */
function createCacheKey(namespace, args) {
  var _context2, _context3;
  return _concatInstanceProperty(_context2 = "".concat(namespace || '', "(")).call(_context2, _mapInstanceProperty(_context3 = _toConsumableArray(args)).call(_context3, function (a) {
    return _JSON$stringify(a);
  }).join(','), ")");
}
function generateKeyString(options, scope, args) {
  return typeof options.key === 'string' ? options.key : typeof options.key === 'function' ? options.key.apply(scope, args) : createCacheKey(options.namespace, args);
}

/**
 * Caching manager for async methods
 *
 * @class
 * @constructor
 */
export var Cache = /*#__PURE__*/function () {
  function Cache() {
    _classCallCheck(this, Cache);
    _defineProperty(this, "_entries", {});
  }
  _createClass(Cache, [{
    key: "get",
    /**
     * retrive cache entry, or create if not exists.
     *
     * @param {String} [key] - Key of cache entry
     * @returns {CacheEntry}
     */
    value: function get(key) {
      if (this._entries[key]) {
        return this._entries[key];
      }
      var entry = new CacheEntry();
      this._entries[key] = entry;
      return entry;
    }
    /**
     * clear cache entries prefix matching given key
     */
  }, {
    key: "clear",
    value: function clear(key) {
      for (var _i = 0, _Object$keys = _Object$keys2(this._entries); _i < _Object$keys.length; _i++) {
        var k = _Object$keys[_i];
        if (!key || _indexOfInstanceProperty(k).call(k, key) === 0) {
          this._entries[k].clear();
        }
      }
    }
    /**
     * Enable caching for async call fn to lookup the response cache first,
     * then invoke original if no cached value.
     */
  }, {
    key: "createCachedFunction",
    value: function createCachedFunction(fn, scope) {
      var _this2 = this;
      var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {
        strategy: 'NOCACHE'
      };
      var strategy = options.strategy;
      var $fn = function $fn() {
        for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
          args[_key2] = arguments[_key2];
        }
        var key = generateKeyString(options, scope, args);
        var entry = _this2.get(key);
        var executeFetch = /*#__PURE__*/function () {
          var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {
            var result;
            return _regeneratorRuntime.wrap(function _callee$(_context4) {
              while (1) {
                switch (_context4.prev = _context4.next) {
                  case 0:
                    entry._fetching = true;
                    _context4.prev = 1;
                    _context4.next = 4;
                    return fn.apply(scope || _this2, args);
                  case 4:
                    result = _context4.sent;
                    entry.set({
                      error: undefined,
                      result: result
                    });
                    return _context4.abrupt("return", result);
                  case 9:
                    _context4.prev = 9;
                    _context4.t0 = _context4["catch"](1);
                    entry.set({
                      error: _context4.t0,
                      result: undefined
                    });
                    throw _context4.t0;
                  case 13:
                  case "end":
                    return _context4.stop();
                }
              }
            }, _callee, null, [[1, 9]]);
          }));
          return function executeFetch() {
            return _ref.apply(this, arguments);
          };
        }();
        var value;
        switch (strategy) {
          case 'IMMEDIATE':
            value = entry.get();
            if (!value) {
              throw new Error('Function call result is not cached yet.');
            }
            if (value.error) {
              throw value.error;
            }
            return value.result;
          case 'HIT':
            return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {
              return _regeneratorRuntime.wrap(function _callee2$(_context5) {
                while (1) {
                  switch (_context5.prev = _context5.next) {
                    case 0:
                      if (entry._fetching) {
                        _context5.next = 3;
                        break;
                      }
                      _context5.next = 3;
                      return executeFetch();
                    case 3:
                      return _context5.abrupt("return", new _Promise(function (resolve, reject) {
                        entry.get(function (_ref3) {
                          var error = _ref3.error,
                            result = _ref3.result;
                          if (error) reject(error);else resolve(result);
                        });
                      }));
                    case 4:
                    case "end":
                      return _context5.stop();
                  }
                }
              }, _callee2);
            }))();
          case 'NOCACHE':
          default:
            return executeFetch();
        }
      };
      $fn.clear = function () {
        for (var _len3 = arguments.length, args = new Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {
          args[_key3] = arguments[_key3];
        }
        var key = generateKeyString(options, scope, args);
        _this2.clear(key);
      };
      return $fn;
    }
  }]);
  return Cache;
}();
export default Cache;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJFdmVudEVtaXR0ZXIiLCJDYWNoZUVudHJ5IiwiX0V2ZW50RW1pdHRlciIsIl9pbmhlcml0cyIsIl9zdXBlciIsIl9jcmVhdGVTdXBlciIsIl9jb250ZXh0IiwiX3RoaXMiLCJfY2xhc3NDYWxsQ2hlY2siLCJfbGVuIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiYXJncyIsIkFycmF5IiwiX2tleSIsImNhbGwiLCJhcHBseSIsIl9jb25jYXRJbnN0YW5jZVByb3BlcnR5IiwiX2RlZmluZVByb3BlcnR5IiwiX2Fzc2VydFRoaXNJbml0aWFsaXplZCIsInVuZGVmaW5lZCIsIl9jcmVhdGVDbGFzcyIsImtleSIsInZhbHVlIiwiZ2V0IiwiY2FsbGJhY2siLCJjYiIsIm9uY2UiLCJ2IiwiX3ZhbHVlIiwiZW1pdCIsInNldCIsImNsZWFyIiwiX2ZldGNoaW5nIiwiY3JlYXRlQ2FjaGVLZXkiLCJuYW1lc3BhY2UiLCJfY29udGV4dDIiLCJfY29udGV4dDMiLCJjb25jYXQiLCJfbWFwSW5zdGFuY2VQcm9wZXJ0eSIsIl90b0NvbnN1bWFibGVBcnJheSIsImEiLCJfSlNPTiRzdHJpbmdpZnkiLCJqb2luIiwiZ2VuZXJhdGVLZXlTdHJpbmciLCJvcHRpb25zIiwic2NvcGUiLCJDYWNoZSIsIl9lbnRyaWVzIiwiZW50cnkiLCJfaSIsIl9PYmplY3Qka2V5cyIsIl9PYmplY3Qka2V5czIiLCJrIiwiX2luZGV4T2ZJbnN0YW5jZVByb3BlcnR5IiwiY3JlYXRlQ2FjaGVkRnVuY3Rpb24iLCJmbiIsIl90aGlzMiIsInN0cmF0ZWd5IiwiJGZuIiwiX2xlbjIiLCJfa2V5MiIsImV4ZWN1dGVGZXRjaCIsIl9yZWYiLCJfYXN5bmNUb0dlbmVyYXRvciIsIl9yZWdlbmVyYXRvclJ1bnRpbWUiLCJtYXJrIiwiX2NhbGxlZSIsInJlc3VsdCIsIndyYXAiLCJfY2FsbGVlJCIsIl9jb250ZXh0NCIsInByZXYiLCJuZXh0Iiwic2VudCIsImVycm9yIiwiYWJydXB0IiwidDAiLCJzdG9wIiwiRXJyb3IiLCJfY2FsbGVlMiIsIl9jYWxsZWUyJCIsIl9jb250ZXh0NSIsIl9Qcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIl9yZWYzIiwiX2xlbjMiLCJfa2V5MyJdLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWNoZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlIE1hbmFnZXMgYXN5bmNocm9ub3VzIG1ldGhvZCByZXNwb25zZSBjYWNoZVxuICogQGF1dGhvciBTaGluaWNoaSBUb21pdGEgPHNoaW5pY2hpLnRvbWl0YUBnbWFpbC5jb20+XG4gKi9cbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cyc7XG5cbi8qKlxuICogdHlwZSBkZWZcbiAqL1xuZXhwb3J0IHR5cGUgQ2FjaGluZ09wdGlvbnMgPSB7XG4gIGtleT86IHN0cmluZyB8ICgoLi4uYXJnczogYW55W10pID0+IHN0cmluZyk7XG4gIG5hbWVzcGFjZT86IHN0cmluZztcbiAgc3RyYXRlZ3k6ICdOT0NBQ0hFJyB8ICdISVQnIHwgJ0lNTUVESUFURSc7XG59O1xuXG50eXBlIENhY2hlVmFsdWU8VD4gPSB7XG4gIGVycm9yPzogRXJyb3I7XG4gIHJlc3VsdDogVDtcbn07XG5cbmV4cG9ydCB0eXBlIENhY2hlZEZ1bmN0aW9uPEZuPiA9IEZuICYgeyBjbGVhcjogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkIH07XG5cbi8qKlxuICogQ2xhc3MgZm9yIG1hbmFnaW5nIGNhY2hlIGVudHJ5XG4gKlxuICogQHByaXZhdGVcbiAqIEBjbGFzc1xuICogQGNvbnN0cnVjdG9yXG4gKiBAdGVtcGxhdGUgVFxuICovXG5jbGFzcyBDYWNoZUVudHJ5PFQ+IGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgX2ZldGNoaW5nOiBib29sZWFuID0gZmFsc2U7XG4gIF92YWx1ZTogQ2FjaGVWYWx1ZTxUPiB8IHZvaWQgPSB1bmRlZmluZWQ7XG5cbiAgLyoqXG4gICAqIEdldCB2YWx1ZSBpbiB0aGUgY2FjaGUgZW50cnlcbiAgICpcbiAgICogQHBhcmFtIHsoKSA9PiBQcm9taXNlPFQ+fSBbY2FsbGJhY2tdIC0gQ2FsbGJhY2sgZnVuY3Rpb24gY2FsbGJhY2tlZCB0aGUgY2FjaGUgZW50cnkgdXBkYXRlZFxuICAgKiBAcmV0dXJucyB7VHx1bmRlZmluZWR9XG4gICAqL1xuICBnZXQoY2FsbGJhY2s/OiAodjogVCkgPT4gYW55KTogQ2FjaGVWYWx1ZTxUPiB8IHZvaWQge1xuICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgY29uc3QgY2IgPSBjYWxsYmFjaztcbiAgICAgIHRoaXMub25jZSgndmFsdWUnLCAodjogVCkgPT4gY2IodikpO1xuICAgICAgaWYgKHR5cGVvZiB0aGlzLl92YWx1ZSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgdGhpcy5lbWl0KCd2YWx1ZScsIHRoaXMuX3ZhbHVlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB2YWx1ZSBpbiB0aGUgY2FjaGUgZW50cnlcbiAgICovXG4gIHNldCh2YWx1ZTogQ2FjaGVWYWx1ZTxUPikge1xuICAgIHRoaXMuX3ZhbHVlID0gdmFsdWU7XG4gICAgdGhpcy5lbWl0KCd2YWx1ZScsIHRoaXMuX3ZhbHVlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciBjYWNoZWQgdmFsdWVcbiAgICovXG4gIGNsZWFyKCkge1xuICAgIHRoaXMuX2ZldGNoaW5nID0gZmFsc2U7XG4gICAgdGhpcy5fdmFsdWUgPSB1bmRlZmluZWQ7XG4gIH1cbn1cblxuLyoqXG4gKiBjcmVhdGUgYW5kIHJldHVybiBjYWNoZSBrZXkgZnJvbSBuYW1lc3BhY2UgYW5kIHNlcmlhbGl6ZWQgYXJndW1lbnRzLlxuICogQHByaXZhdGVcbiAqL1xuZnVuY3Rpb24gY3JlYXRlQ2FjaGVLZXkobmFtZXNwYWNlOiBzdHJpbmcgfCB2b2lkLCBhcmdzOiBhbnlbXSk6IHN0cmluZyB7XG4gIHJldHVybiBgJHtuYW1lc3BhY2UgfHwgJyd9KCR7Wy4uLmFyZ3NdXG4gICAgLm1hcCgoYSkgPT4gSlNPTi5zdHJpbmdpZnkoYSkpXG4gICAgLmpvaW4oJywnKX0pYDtcbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVLZXlTdHJpbmcoXG4gIG9wdGlvbnM6IENhY2hpbmdPcHRpb25zLFxuICBzY29wZTogYW55LFxuICBhcmdzOiBhbnlbXSxcbik6IHN0cmluZyB7XG4gIHJldHVybiB0eXBlb2Ygb3B0aW9ucy5rZXkgPT09ICdzdHJpbmcnXG4gICAgPyBvcHRpb25zLmtleVxuICAgIDogdHlwZW9mIG9wdGlvbnMua2V5ID09PSAnZnVuY3Rpb24nXG4gICAgPyBvcHRpb25zLmtleS5hcHBseShzY29wZSwgYXJncylcbiAgICA6IGNyZWF0ZUNhY2hlS2V5KG9wdGlvbnMubmFtZXNwYWNlLCBhcmdzKTtcbn1cblxuLyoqXG4gKiBDYWNoaW5nIG1hbmFnZXIgZm9yIGFzeW5jIG1ldGhvZHNcbiAqXG4gKiBAY2xhc3NcbiAqIEBjb25zdHJ1Y3RvclxuICovXG5leHBvcnQgY2xhc3MgQ2FjaGUge1xuICBwcml2YXRlIF9lbnRyaWVzOiB7IFtrZXk6IHN0cmluZ106IENhY2hlRW50cnk8YW55PiB9ID0ge307XG5cbiAgLyoqXG4gICAqIHJldHJpdmUgY2FjaGUgZW50cnksIG9yIGNyZWF0ZSBpZiBub3QgZXhpc3RzLlxuICAgKlxuICAgKiBAcGFyYW0ge1N0cmluZ30gW2tleV0gLSBLZXkgb2YgY2FjaGUgZW50cnlcbiAgICogQHJldHVybnMge0NhY2hlRW50cnl9XG4gICAqL1xuICBnZXQoa2V5OiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy5fZW50cmllc1trZXldKSB7XG4gICAgICByZXR1cm4gdGhpcy5fZW50cmllc1trZXldO1xuICAgIH1cbiAgICBjb25zdCBlbnRyeSA9IG5ldyBDYWNoZUVudHJ5KCk7XG4gICAgdGhpcy5fZW50cmllc1trZXldID0gZW50cnk7XG4gICAgcmV0dXJuIGVudHJ5O1xuICB9XG5cbiAgLyoqXG4gICAqIGNsZWFyIGNhY2hlIGVudHJpZXMgcHJlZml4IG1hdGNoaW5nIGdpdmVuIGtleVxuICAgKi9cbiAgY2xlYXIoa2V5Pzogc3RyaW5nKSB7XG4gICAgZm9yIChjb25zdCBrIG9mIE9iamVjdC5rZXlzKHRoaXMuX2VudHJpZXMpKSB7XG4gICAgICBpZiAoIWtleSB8fCBrLmluZGV4T2Yoa2V5KSA9PT0gMCkge1xuICAgICAgICB0aGlzLl9lbnRyaWVzW2tdLmNsZWFyKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEVuYWJsZSBjYWNoaW5nIGZvciBhc3luYyBjYWxsIGZuIHRvIGxvb2t1cCB0aGUgcmVzcG9uc2UgY2FjaGUgZmlyc3QsXG4gICAqIHRoZW4gaW52b2tlIG9yaWdpbmFsIGlmIG5vIGNhY2hlZCB2YWx1ZS5cbiAgICovXG4gIGNyZWF0ZUNhY2hlZEZ1bmN0aW9uPEZuIGV4dGVuZHMgRnVuY3Rpb24+KFxuICAgIGZuOiBGbixcbiAgICBzY29wZTogYW55LFxuICAgIG9wdGlvbnM6IENhY2hpbmdPcHRpb25zID0geyBzdHJhdGVneTogJ05PQ0FDSEUnIH0sXG4gICk6IENhY2hlZEZ1bmN0aW9uPEZuPiB7XG4gICAgY29uc3Qgc3RyYXRlZ3kgPSBvcHRpb25zLnN0cmF0ZWd5O1xuICAgIGNvbnN0ICRmbjogYW55ID0gKC4uLmFyZ3M6IGFueVtdKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBnZW5lcmF0ZUtleVN0cmluZyhvcHRpb25zLCBzY29wZSwgYXJncyk7XG4gICAgICBjb25zdCBlbnRyeSA9IHRoaXMuZ2V0KGtleSk7XG4gICAgICBjb25zdCBleGVjdXRlRmV0Y2ggPSBhc3luYyAoKSA9PiB7XG4gICAgICAgIGVudHJ5Ll9mZXRjaGluZyA9IHRydWU7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZm4uYXBwbHkoc2NvcGUgfHwgdGhpcywgYXJncyk7XG4gICAgICAgICAgZW50cnkuc2V0KHsgZXJyb3I6IHVuZGVmaW5lZCwgcmVzdWx0IH0pO1xuICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgZW50cnkuc2V0KHsgZXJyb3I6IGVycm9yIGFzIEVycm9yLCByZXN1bHQ6IHVuZGVmaW5lZCB9KTtcbiAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIGxldCB2YWx1ZTtcbiAgICAgIHN3aXRjaCAoc3RyYXRlZ3kpIHtcbiAgICAgICAgY2FzZSAnSU1NRURJQVRFJzpcbiAgICAgICAgICB2YWx1ZSA9IGVudHJ5LmdldCgpO1xuICAgICAgICAgIGlmICghdmFsdWUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRnVuY3Rpb24gY2FsbCByZXN1bHQgaXMgbm90IGNhY2hlZCB5ZXQuJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh2YWx1ZS5lcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgdmFsdWUuZXJyb3I7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB2YWx1ZS5yZXN1bHQ7XG4gICAgICAgIGNhc2UgJ0hJVCc6XG4gICAgICAgICAgcmV0dXJuIChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWVudHJ5Ll9mZXRjaGluZykge1xuICAgICAgICAgICAgICAvLyBvbmx5IHdoZW4gbm8gb3RoZXIgY2xpZW50IGlzIGNhbGxpbmcgZnVuY3Rpb25cbiAgICAgICAgICAgICAgYXdhaXQgZXhlY3V0ZUZldGNoKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICBlbnRyeS5nZXQoKHsgZXJyb3IsIHJlc3VsdCB9KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycm9yKSByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgICAgIGVsc2UgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pKCk7XG4gICAgICAgIGNhc2UgJ05PQ0FDSEUnOlxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIHJldHVybiBleGVjdXRlRmV0Y2goKTtcbiAgICAgIH1cbiAgICB9O1xuICAgICRmbi5jbGVhciA9ICguLi5hcmdzOiBhbnlbXSkgPT4ge1xuICAgICAgY29uc3Qga2V5ID0gZ2VuZXJhdGVLZXlTdHJpbmcob3B0aW9ucywgc2NvcGUsIGFyZ3MpO1xuICAgICAgdGhpcy5jbGVhcihrZXkpO1xuICAgIH07XG4gICAgcmV0dXJuICRmbiBhcyBDYWNoZWRGdW5jdGlvbjxGbj47XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQ2FjaGU7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBU0EsWUFBWSxRQUFRLFFBQVE7O0FBRXJDO0FBQ0E7QUFDQTtBQWNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFQQSxJQVFNQyxVQUFVLDBCQUFBQyxhQUFBO0VBQUFDLFNBQUEsQ0FBQUYsVUFBQSxFQUFBQyxhQUFBO0VBQUEsSUFBQUUsTUFBQSxHQUFBQyxZQUFBLENBQUFKLFVBQUE7RUFBQSxTQUFBQSxXQUFBO0lBQUEsSUFBQUssUUFBQTtJQUFBLElBQUFDLEtBQUE7SUFBQUMsZUFBQSxPQUFBUCxVQUFBO0lBQUEsU0FBQVEsSUFBQSxHQUFBQyxTQUFBLENBQUFDLE1BQUEsRUFBQUMsSUFBQSxPQUFBQyxLQUFBLENBQUFKLElBQUEsR0FBQUssSUFBQSxNQUFBQSxJQUFBLEdBQUFMLElBQUEsRUFBQUssSUFBQTtNQUFBRixJQUFBLENBQUFFLElBQUEsSUFBQUosU0FBQSxDQUFBSSxJQUFBO0lBQUE7SUFBQVAsS0FBQSxHQUFBSCxNQUFBLENBQUFXLElBQUEsQ0FBQUMsS0FBQSxDQUFBWixNQUFBLEVBQUFhLHVCQUFBLENBQUFYLFFBQUEsV0FBQVMsSUFBQSxDQUFBVCxRQUFBLEVBQUFNLElB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