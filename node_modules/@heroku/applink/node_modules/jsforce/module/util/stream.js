import "core-js/modules/es.array.iterator";
import "core-js/modules/es.promise";
import _Promise from "@babel/runtime-corejs3/core-js-stable/promise";
import _mapInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/map";
import _concatInstanceProperty from "@babel/runtime-corejs3/core-js-stable/instance/concat";
import _defineProperty from "@babel/runtime-corejs3/helpers/defineProperty";
import { Duplex, PassThrough, Writable } from 'stream';
export function createLazyStream() {
  const ins = new PassThrough();
  const outs = new PassThrough();
  const stream = concatStreamsAsDuplex(ins, outs);
  let piped = false;
  const setStream = str => {
    if (piped) {
      throw new Error('stream is already piped to actual stream');
    }
    piped = true;
    ins.pipe(str).pipe(outs);
  };
  return {
    stream,
    setStream
  };
}
class MemoryWriteStream extends Writable {
  constructor() {
    super();
    _defineProperty(this, "_buf", void 0);
    this._buf = Buffer.alloc(0);
  }
  _write(chunk, encoding, callback) {
    this._buf = _concatInstanceProperty(Buffer).call(Buffer, [this._buf, chunk]);
    callback();
  }
  _writev(data, callback) {
    this._buf = _concatInstanceProperty(Buffer).call(Buffer, [this._buf, ..._mapInstanceProperty(data).call(data, ({
      chunk
    }) => chunk)]);
    callback();
  }
  toString(encoding = 'utf-8') {
    return this._buf.toString(encoding);
  }
}
export async function readAll(rs, encoding = 'utf-8') {
  return new _Promise((resolve, reject) => {
    const ws = new MemoryWriteStream();
    rs.on('error', reject).pipe(ws).on('finish', () => resolve(ws.toString(encoding)));
  });
}
class DuplexifiedStream extends Duplex {
  constructor(ws, rs, opts = {}) {
    var _opts$writableObjectM, _opts$readableObjectM;
    super({
      writableObjectMode: (_opts$writableObjectM = opts.writableObjectMode) !== null && _opts$writableObjectM !== void 0 ? _opts$writableObjectM : ws.writableObjectMode,
      readableObjectMode: (_opts$readableObjectM = opts.readableObjectMode) !== null && _opts$readableObjectM !== void 0 ? _opts$readableObjectM : rs.readableObjectMode
    });
    _defineProperty(this, "_writable", void 0);
    _defineProperty(this, "_readable", void 0);
    this._writable = ws;
    this._readable = rs;
    ws.once('finish', () => {
      this.end();
    });
    this.once('finish', () => {
      ws.end();
    });
    rs.on('readable', () => {
      this._readStream();
    });
    rs.once('end', () => {
      this.push(null);
    });
    ws.on('error', err => this.emit('error', err));
    rs.on('error', err => this.emit('error', err));
  }
  _write(chunk, encoding, callback) {
    this._writable.write(chunk, encoding, callback);
  }
  _read(n) {
    this._readStream(n);
  }
  _readStream(n) {
    let data;
    while ((data = this._readable.read(n)) !== null) {
      this.push(data);
    }
  }
}
export function concatStreamsAsDuplex(ws, rs, opts) {
  return new DuplexifiedStream(ws, rs, opts);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJEdXBsZXgiLCJQYXNzVGhyb3VnaCIsIldyaXRhYmxlIiwiY3JlYXRlTGF6eVN0cmVhbSIsImlucyIsIm91dHMiLCJzdHJlYW0iLCJjb25jYXRTdHJlYW1zQXNEdXBsZXgiLCJwaXBlZCIsInNldFN0cmVhbSIsInN0ciIsIkVycm9yIiwicGlwZSIsIk1lbW9yeVdyaXRlU3RyZWFtIiwiY29uc3RydWN0b3IiLCJfZGVmaW5lUHJvcGVydHkiLCJfYnVmIiwiQnVmZmVyIiwiYWxsb2MiLCJfd3JpdGUiLCJjaHVuayIsImVuY29kaW5nIiwiY2FsbGJhY2siLCJfY29uY2F0SW5zdGFuY2VQcm9wZXJ0eSIsImNhbGwiLCJfd3JpdGV2IiwiZGF0YSIsIl9tYXBJbnN0YW5jZVByb3BlcnR5IiwidG9TdHJpbmciLCJyZWFkQWxsIiwicnMiLCJfUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJ3cyIsIm9uIiwiRHVwbGV4aWZpZWRTdHJlYW0iLCJvcHRzIiwiX29wdHMkd3JpdGFibGVPYmplY3RNIiwiX29wdHMkcmVhZGFibGVPYmplY3RNIiwid3JpdGFibGVPYmplY3RNb2RlIiwicmVhZGFibGVPYmplY3RNb2RlIiwiX3dyaXRhYmxlIiwiX3JlYWRhYmxlIiwib25jZSIsImVuZCIsIl9yZWFkU3RyZWFtIiwicHVzaCIsImVyciIsImVtaXQiLCJ3cml0ZSIsIl9yZWFkIiwibiIsInJlYWQiXSwic291cmNlcyI6WyIuLi8uLi9zcmMvdXRpbC9zdHJlYW0udHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRHVwbGV4LCBQYXNzVGhyb3VnaCwgUmVhZGFibGUsIFdyaXRhYmxlIH0gZnJvbSAnc3RyZWFtJztcblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUxhenlTdHJlYW0oKSB7XG4gIGNvbnN0IGlucyA9IG5ldyBQYXNzVGhyb3VnaCgpO1xuICBjb25zdCBvdXRzID0gbmV3IFBhc3NUaHJvdWdoKCk7XG4gIGNvbnN0IHN0cmVhbSA9IGNvbmNhdFN0cmVhbXNBc0R1cGxleChpbnMsIG91dHMpO1xuICBsZXQgcGlwZWQgPSBmYWxzZTtcbiAgY29uc3Qgc2V0U3RyZWFtID0gKHN0cjogRHVwbGV4KSA9PiB7XG4gICAgaWYgKHBpcGVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3N0cmVhbSBpcyBhbHJlYWR5IHBpcGVkIHRvIGFjdHVhbCBzdHJlYW0nKTtcbiAgICB9XG4gICAgcGlwZWQgPSB0cnVlO1xuICAgIGlucy5waXBlKHN0cikucGlwZShvdXRzKTtcbiAgfTtcbiAgcmV0dXJuIHsgc3RyZWFtLCBzZXRTdHJlYW0gfTtcbn1cblxuY2xhc3MgTWVtb3J5V3JpdGVTdHJlYW0gZXh0ZW5kcyBXcml0YWJsZSB7XG4gIF9idWY6IEJ1ZmZlcjtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX2J1ZiA9IEJ1ZmZlci5hbGxvYygwKTtcbiAgfVxuXG4gIF93cml0ZShjaHVuazogQnVmZmVyLCBlbmNvZGluZzogc3RyaW5nLCBjYWxsYmFjazogRnVuY3Rpb24pIHtcbiAgICB0aGlzLl9idWYgPSBCdWZmZXIuY29uY2F0KFt0aGlzLl9idWYsIGNodW5rXSk7XG4gICAgY2FsbGJhY2soKTtcbiAgfVxuXG4gIF93cml0ZXYoXG4gICAgZGF0YTogQXJyYXk8eyBjaHVuazogQnVmZmVyOyBlbmNvZGluZzogc3RyaW5nIH0+LFxuICAgIGNhbGxiYWNrOiBGdW5jdGlvbixcbiAgKSB7XG4gICAgdGhpcy5fYnVmID0gQnVmZmVyLmNvbmNhdChbdGhpcy5fYnVmLCAuLi5kYXRhLm1hcCgoeyBjaHVuayB9KSA9PiBjaHVuayldKTtcbiAgICBjYWxsYmFjaygpO1xuICB9XG5cbiAgdG9TdHJpbmcoZW5jb2Rpbmc6IHN0cmluZyA9ICd1dGYtOCcpIHtcbiAgICByZXR1cm4gdGhpcy5fYnVmLnRvU3RyaW5nKGVuY29kaW5nKTtcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVhZEFsbChyczogUmVhZGFibGUsIGVuY29kaW5nOiBzdHJpbmcgPSAndXRmLTgnKSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCB3cyA9IG5ldyBNZW1vcnlXcml0ZVN0cmVhbSgpO1xuICAgIHJzLm9uKCdlcnJvcicsIHJlamVjdClcbiAgICAgIC5waXBlKHdzKVxuICAgICAgLm9uKCdmaW5pc2gnLCAoKSA9PiByZXNvbHZlKHdzLnRvU3RyaW5nKGVuY29kaW5nKSkpO1xuICB9KTtcbn1cblxuY2xhc3MgRHVwbGV4aWZpZWRTdHJlYW0gZXh0ZW5kcyBEdXBsZXgge1xuICBfd3JpdGFibGU6IFdyaXRhYmxlO1xuICBfcmVhZGFibGU6IFJlYWRhYmxlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHdzOiBXcml0YWJsZSxcbiAgICByczogUmVhZGFibGUsXG4gICAgb3B0czogeyB3cml0YWJsZU9iamVjdE1vZGU/OiBib29sZWFuOyByZWFkYWJsZU9iamVjdE1vZGU/OiBib29sZWFuIH0gPSB7fSxcbiAgKSB7XG4gICAgc3VwZXIoe1xuICAgICAgd3JpdGFibGVPYmplY3RNb2RlOiBvcHRzLndyaXRhYmxlT2JqZWN0TW9kZSA/PyB3cy53cml0YWJsZU9iamVjdE1vZGUsXG4gICAgICByZWFkYWJsZU9iamVjdE1vZGU6IG9wdHMucmVhZGFibGVPYmplY3RNb2RlID8/IHJzLnJlYWRhYmxlT2JqZWN0TW9kZSxcbiAgICB9KTtcbiAgICB0aGlzLl93cml0YWJsZSA9IHdzO1xuICAgIHRoaXMuX3JlYWRhYmxlID0gcnM7XG4gICAgd3Mub25jZSgnZmluaXNoJywgKCkgPT4ge1xuICAgICAgdGhpcy5lbmQoKTtcbiAgICB9KTtcbiAgICB0aGlzLm9uY2UoJ2ZpbmlzaCcsICgpID0+IHtcbiAgICAgIHdzLmVuZCgpO1xuICAgIH0pO1xuICAgIHJzLm9uKCdyZWFkYWJsZScsICgpID0+IHtcbiAgICAgIHRoaXMuX3JlYWRTdHJlYW0oKTtcbiAgICB9KTtcbiAgICBycy5vbmNlKCdlbmQnLCAoKSA9PiB7XG4gICAgICB0aGlzLnB1c2gobnVsbCk7XG4gICAgfSk7XG4gICAgd3Mub24oJ2Vycm9yJywgKGVycikgPT4gdGhpcy5lbWl0KCdlcnJvcicsIGVycikpO1xuICAgIHJzLm9uKCdlcnJvcicsIChlcnIpID0+IHRoaXMuZW1pdCgnZXJyb3InLCBlcnIpKTtcbiAgfVxuXG4gIF93cml0ZShjaHVuazogYW55LCBlbmNvZGluZzogYW55LCBjYWxsYmFjazogYW55KSB7XG4gICAgdGhpcy5fd3JpdGFibGUud3JpdGUoY2h1bmssIGVuY29kaW5nLCBjYWxsYmFjayk7XG4gIH1cblxuICBfcmVhZChuOiBudW1iZXIpIHtcbiAgICB0aGlzLl9yZWFkU3RyZWFtKG4pO1xuICB9XG5cbiAgX3JlYWRTdHJlYW0obj86IG51bWJlcikge1xuICAgIGxldCBkYXRhO1xuICAgIHdoaWxlICgoZGF0YSA9IHRoaXMuX3JlYWRhYmxlLnJlYWQobikpICE9PSBudWxsKSB7XG4gICAgICB0aGlzLnB1c2goZGF0YSk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25jYXRTdHJlYW1zQXNEdXBsZXgoXG4gIHdzOiBXcml0YWJsZSxcbiAgcnM6IFJlYWRhYmxlLFxuICBvcHRzPzogeyB3cml0YWJsZU9iamVjdE1vZGU/OiBib29sZWFuOyByZWFkYWJsZU9iamVjdE1vZGU/OiBib29sZWFuIH0sXG4pOiBEdXBsZXgge1xuICByZXR1cm4gbmV3IER1cGxleGlmaWVkU3RyZWFtKHdzLCBycywgb3B0cyk7XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLFNBQVNBLE1BQU0sRUFBRUMsV0FBVyxFQUFZQyxRQUFRLFFBQVEsUUFBUTtBQUVoRSxPQUFPLFNBQVNDLGdCQUFnQkEsQ0FBQSxFQUFHO0VBQ2pDLE1BQU1DLEdBQUcsR0FBRyxJQUFJSCxXQUFXLENBQUMsQ0FBQztFQUM3QixNQUFNSSxJQUFJLEdBQUcsSUFBSUosV0FBVyxDQUFDLENBQUM7RUFDOUIsTUFBTUssTUFBTSxHQUFHQyxxQkFBcUIsQ0FBQ0gs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